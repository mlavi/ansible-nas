# shellcheck shell=bash

# If .env missing; restore from .env.sample and validate
# See https://github.com/direnv/direnv/wiki/.envrc-Boilerplate
if [[ -f .env.sample ]]; then
  if ! command -v createnv > /dev/null; then
    echo 'WARN|Createnv missing; try: pyenv local 3.x && pip install createnv'
  elif [[ ! -f .env ]]; then
    createnv --use-default --overwrite \
      || echo 'ERROR|https://github.com/cuducos/createnv'
    if command dotenv-linter --version >&/dev/null; then
      dotenv-linter .env || echo 'ERROR|https://dotenv-linter.github.io'
    fi
  fi
fi

dotenv_if_exists || direnv status # https://direnv.net/man/direnv-stdlib.1.html
dotenv_if_exists .env.mlavi.homelab.sample
# dotenv_if_exists .env.troubleshooting.sample

if on_git_branch main; then
  echo && git status --short --branch \
    && git fetch --verbose upstream && git merge upstream/main && echo '|MERGE|remote upstream: done.'
else
  echo && git status --short --branch && echo
fi

diff nas.yml nas-mlavi.homelab.yaml

cat <<- 'MotD'
- How to confirm proper release? in /requirements.yml
  - ansible-galaxy install -r requirements.yml
    - ~/.ansible/roles/geerlingguy.docker/meta/.galaxy_install_info
    https://galaxy.ansible.com/ui/standalone/roles/geerlingguy/docker
    https://github.com/geerlingguy/ansible-role-docker
  - Lifecycle
    TODO: ansible-galaxy collection install vladgh.samba --upgrade && ansible-galaxy collection list
    https://docs.ansible.com/ansible/latest/collections_guide/index.html

    ansible-galaxy role list
    ansible-galaxy role info geerlingguy.docker | grep install
    ansible-galaxy role remove geerlingguy.docker && ansible-galaxy role list
    ansible-galaxy role install geerlingguy.docker
  - versus: ssh ansible-nas sudo su ansible
    # cd ~ansible && curl -fsSL get.docker.com -o get-docker.sh && sh get-docker.sh
    # To run Docker as a non-privileged user, consider setting up the
    # Docker daemon in rootless mode for your user:
    #  dockerd-rootless-setuptool.sh install
    # Visit https://docs.docker.com/go/rootless/ to learn about rootless mode.
    # To run the Docker daemon as a fully privileged service, but granting non-root
    # users access, refer to https://docs.docker.com/go/daemon-access/
    # sudo usermod -aG docker ansible && docker info

ansible-playbook nas.yml --limit nas --start-at-task=homeassistant* # --list-tags
ansible-playbook nas-mlavi.homelab.yaml --start-at-task=mlavi.homelab.homeassistant* --start-at-task=mlavi.homelab.samba4_ad_dc*
ansible-playbook nas-mlavi.homelab.yaml --start-at-task=ansible-nas-docker*
MotD
